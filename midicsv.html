<!DOCTYPE html>
<html>
<head>
  <title>MIDI-CSV Converter</title>
</head>
<body>
  <h1>MIDI-CSV Converter</h1>
  <input type="file" id="midiInput" />
  <button onclick="convertMidiCsv()">Convert MIDI to CSV</button>

  <h1>CSV-MIDI Converter</h1>
  <input type="file" id="csvInput" />
  <button onclick="convertCsvMidi()">Convert CSV to MIDI</button>

  <div id="outputTable"></div>

  <script>
    var midiInput = document.getElementById('midiInput');
    var csvInput = document.getElementById('csvInput');

    function convertMidiCsv() {
      var file = midiInput.files[0];
      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var arrayBuffer = e.target.result;
          var byteArray = new Uint8Array(arrayBuffer);

          // Write the file to MEMFS
          FS.writeFile('/input.midi', byteArray);

          // Call your WebAssembly function
          Module._midicsv();

          // Read the output file from MEMFS
          var output = FS.readFile('/output.csv', { encoding: 'utf8' });
          var blob = new Blob([output], { type: 'text/csv' });
          var url = URL.createObjectURL(blob);
          var link = document.createElement('a');
          link.href = url;
          link.download = 'output.csv';
          link.click();

          displayCSVAsTable(output);
        };
        reader.readAsArrayBuffer(file);
      }
    }

    function convertCsvMidi() {
      var file = csvInput.files[0];
      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var arrayBuffer = e.target.result;
          var byteArray = new Uint8Array(arrayBuffer);

          // Write the file to MEMFS
          FS.writeFile('/input.csv', byteArray);

          // Call your WebAssembly function
          Module._csvmidi();

          // Read the output file from MEMFS
          var output = FS.readFile('/output.midi');
          var blob = new Blob([output], { type: 'audio/midi' });
          var url = URL.createObjectURL(blob);
          var link = document.createElement('a');
          link.href = url;
          link.download = 'output.midi';
          link.click();
        };
        reader.readAsArrayBuffer(file);
      }
    }

    function sanitizeHTML(str) {
      var temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    function displayCSVAsTable(csv) {
      const lines = csv.split('\n');
      let table = '<table><thead><tr>';
      table += '<th>Track</th>';
      table += '<th>Time</th>';
      table += '<th>Type</th>';
      table += '<th>Channel</th>';
      table += '<th>Note</th>';
      table += '<th>Velocity</th>';
      table += '</tr></thead><tbody>';
      
      lines.forEach((line, index) => {
        const cells = line.split(',');
        table += '<tr>';
        cells.forEach(cell => {
          table += `<td>${sanitizeHTML(cell.trim())}</td>`;
        });
        table += '</tr>';
      });

      table += '</tbody></table>';
      document.getElementById('outputTable').innerHTML = table;
    }

    // Load the WebAssembly module
    var Module = {
      onRuntimeInitialized: function() {
        console.log('WebAssembly module loaded');
      }
    };
  </script>
  <script src="csvmidi.js"></script>
</body>
</html>
